<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KelvinChat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Helvetica+Neue:wght@400&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
    }
  </style>
</head>
<body class="bg-gray-100 flex justify-center items-center h-screen">
  <div id="name-container" class="flex flex-col justify-center items-center bg-blue-500 text-white p-6 rounded-lg w-full max-w-md">
    <h1 class="text-2xl mb-4">Bem-vindo ao KelvinChat</h1>
    <input type="text" id="name-input" placeholder="Digite seu nome" class="p-2 text-gray-800 rounded mb-4 w-full max-w-xs">
    <button id="enter-chat" class="p-2 bg-blue-700 text-white rounded w-full max-w-xs">Entrar</button>
  </div>

  <div id="chat-container" class="hidden flex-col bg-white w-full max-w-lg h-4/5 rounded-lg shadow-lg">
    <div id="header" class="bg-blue-500 text-white p-4 text-center rounded-t-lg">KelvinChat</div>
    <div id="messages" class="flex-1 overflow-y-auto p-4 bg-gray-100"></div>
    <div id="input-container" class="flex items-center p-4 bg-gray-200 rounded-b-lg">
      <input type="text" id="message-input" placeholder="Digite sua mensagem" class="flex-1 p-2 border border-gray-300 rounded">
      <button id="send-button" class="p-2 bg-blue-500 text-white rounded ml-2">Enviar</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, get, set } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

    // Configuração do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCPCljNgir3YlR1UV6h3Qyik84AYOp0u4A",
      authDomain: "crmpro-6b032.firebaseapp.com",
      databaseURL: "https://crmpro-6b032-default-rtdb.firebaseio.com",
      projectId: "crmpro-6b032",
      storageBucket: "crmpro-6b032.appspot.com",
      messagingSenderId: "491350225551",
      appId: "1:491350225551:web:0dd6f83a2d49752ca9b6fa",
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const usersRef = ref(database, 'Users');
    const chatRef = ref(database, 'chat');

    const nameContainer = document.getElementById("name-container");
    const chatContainer = document.getElementById("chat-container");
    const nameInput = document.getElementById("name-input");
    const enterChatButton = document.getElementById("enter-chat");
    const messagesDiv = document.getElementById("messages");
    const messageInput = document.getElementById("message-input");
    const sendButton = document.getElementById("send-button");

    let username = localStorage.getItem('username') || '';
    let userId = localStorage.getItem('userId') || null;

    // Criar usuário no Firebase se não existir
    function createUserNode() {
      if (username && !userId) {
        const newUserRef = push(usersRef);
        userId = newUserRef.key;
        set(newUserRef, {
          name: username,
          blocked: false,
        });
        localStorage.setItem('userId', userId);
      }
    }

    // Verificar se o usuário está bloqueado
    function checkUserBlocked() {
      if (!userId) return;
      get(ref(database, `Users/${userId}`)).then((snapshot) => {
        if (snapshot.exists()) {
          const userData = snapshot.val();
          if (userData.blocked) {
            window.location.href = 'banido.html'; // Redireciona se estiver bloqueado
          } else {
            showChat();
          }
        }
      });
    }

    // Exibir chat
    function showChat() {
      nameContainer.style.display = "none";
      chatContainer.style.display = "flex";
    }

    // Lidar com botão de entrar
    enterChatButton.addEventListener("click", () => {
      username = nameInput.value.trim();
      if (username) {
        localStorage.setItem('username', username);
        createUserNode();
        checkUserBlocked();
      } else {
        alert("Por favor, insira seu nome!");
      }
    });

    // Enviar mensagens
    sendButton.addEventListener("click", () => {
      const text = messageInput.value.trim();
      if (text && userId) {
        push(chatRef, { sender: username, text, userId });
        messageInput.value = "";
      }
    });

    // Carregar mensagens
    onValue(chatRef, (snapshot) => {
      messagesDiv.innerHTML = "";
      snapshot.forEach((childSnapshot) => {
        const message = childSnapshot.val();
        const messageDiv = document.createElement("div");
        messageDiv.classList.add("mb-2");
        messageDiv.textContent = `${message.sender}: ${message.text}`;
        messagesDiv.appendChild(messageDiv);
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
  </script>
</body>
</html>
