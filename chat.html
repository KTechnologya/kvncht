<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Chat</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
</head>
<body class="bg-gray-100 p-4">
  <div class="container mx-auto max-w-md bg-white p-4 shadow-md rounded">
    <h1 class="text-2xl font-bold mb-4">Chat em Tempo Real</h1>
    <div id="login" class="mb-4">
      <input id="username" type="text" placeholder="Digite seu nome" class="border p-2 w-full mb-2">
      <button id="loginButton" class="bg-blue-500 text-white p-2 rounded w-full">Entrar</button>
    </div>
    <div id="chatroom" class="hidden">
      <div id="messages" class="h-64 overflow-y-scroll bg-gray-50 p-2 border rounded mb-4"></div>
      <div id="adminControls" class="hidden mb-4">
        <h2 class="text-lg font-bold">Controles do Admin</h2>
        <input id="userIdInput" type="text" placeholder="ID do Usuário" class="border p-2 w-full mb-2">
        <button id="verifyUserButton" class="bg-green-500 text-white p-2 rounded w-full mb-2">Marcar como Verificado</button>
        <button id="unverifyUserButton" class="bg-red-500 text-white p-2 rounded w-full">Desmarcar Verificado</button>
      </div>
      <input id="messageInput" type="text" placeholder="Digite uma mensagem" class="border p-2 w-full mb-2">
      <button id="sendButton" class="bg-blue-500 text-white p-2 rounded w-full">Enviar</button>
    </div>
  </div>

  <script>
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyAka2HFWwP9OHc_OC2IDFio0wPPtqADhmA",
      authDomain: "kelvinchat-f9499.firebaseapp.com",
      databaseURL: "https://kelvinchat-f9499-default-rtdb.firebaseio.com",
      projectId: "kelvinchat-f9499",
      storageBucket: "kelvinchat-f9499.firebasestorage.app",
      messagingSenderId: "972962322611",
      appId: "1:972962322611:web:ff5416bb049abea350f8c6",
      measurementId: "G-K99GCK98ZR"
    };

    // Inicialização do Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      push,
      set,
      onValue,
      get
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const chatRef = ref(database, "Chat");
    const usersRef = ref(database, "Users");

    let userId = localStorage.getItem("userId");
    let username = "";

    const loginButton = document.getElementById("loginButton");
    const usernameInput = document.getElementById("username");
    const chatroom = document.getElementById("chatroom");
    const loginDiv = document.getElementById("login");
    const messagesDiv = document.getElementById("messages");
    const messageInput = document.getElementById("messageInput");
    const sendButton = document.getElementById("sendButton");
    const adminControls = document.getElementById("adminControls");

    const userIdInput = document.getElementById("userIdInput");
    const verifyUserButton = document.getElementById("verifyUserButton");
    const unverifyUserButton = document.getElementById("unverifyUserButton");

    // Função para criar usuário no Firebase
    const createUserNode = () => {
      if (username && !userId) {
        const newUserRef = push(usersRef);
        userId = newUserRef.key;
        set(newUserRef, { name: username, blocked: false, verified: false });
        localStorage.setItem("userId", userId);
      }
    };

    // Função de login
    loginButton.addEventListener("click", () => {
      username = usernameInput.value.trim();
      if (!username) {
        alert("Digite seu nome.");
        return;
      }
      createUserNode();
      loginDiv.classList.add("hidden");
      chatroom.classList.remove("hidden");

      if (username === "admin") {
        adminControls.classList.remove("hidden");
      }
    });

    // Enviar mensagens
    sendButton.addEventListener("click", () => {
      const message = messageInput.value.trim();
      if (message) {
        const newMessageRef = push(chatRef);
        set(newMessageRef, { text: message, sender: username, userId });
        messageInput.value = "";
      }
    });

    // Exibir mensagens e status de verificação
    onValue(chatRef, (snapshot) => {
      messagesDiv.innerHTML = "";
      snapshot.forEach((childSnapshot) => {
        const message = childSnapshot.val();
        const messageDiv = document.createElement("div");
        messageDiv.classList.add("mb-2");

        const sender = document.createElement("span");
        sender.textContent = message.sender;

        get(ref(database, `Users/${message.userId}`)).then((userSnapshot) => {
          if (userSnapshot.exists()) {
            const userData = userSnapshot.val();
            if (userData.verified) {
              const verifiedBadge = document.createElement("span");
              verifiedBadge.textContent = " ✔";
              verifiedBadge.classList.add("text-green-500", "ml-1");
              sender.appendChild(verifiedBadge);
            }
          }
        });

        messageDiv.appendChild(sender);
        if (message.text) {
          const messageText = document.createElement("p");
          messageText.textContent = `: ${message.text}`;
          messageDiv.appendChild(messageText);
        }
        messagesDiv.appendChild(messageDiv);
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

    // Gerenciar verificação de usuários
    verifyUserButton.addEventListener("click", () => {
      const userId = userIdInput.value.trim();
      if (userId) {
        set(ref(database, `Users/${userId}/verified`), true).then(() => {
          alert("Usuário marcado como verificado.");
        });
      }
    });

    unverifyUserButton.addEventListener("click", () => {
      const userId = userIdInput.value.trim();
      if (userId) {
        set(ref(database, `Users/${userId}/verified`), false).then(() => {
          alert("Usuário desmarcado como verificado.");
        });
      }
    });
  </script>
</body>
</html>
