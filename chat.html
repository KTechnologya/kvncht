<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KelvinChat</title>
  <script type="module">
    // Importação do Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, push, update } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

    // Configuração Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAka2HFWwP9OHc_OC2IDFio0wPPtqADhmA",
      authDomain: "kelvinchat-f9499.firebaseapp.com",
      databaseURL: "https://kelvinchat-f9499-default-rtdb.firebaseio.com",
      projectId: "kelvinchat-f9499",
      storageBucket: "kelvinchat-f9499.storage.app",
      messagingSenderId: "972962322611",
      appId: "1:972962322611:web:ff5416bb049abea350f8c6",
      measurementId: "G-K99GCK98ZR",
    };

    // Inicialização do Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Cadastro de usuário
    const userId = localStorage.getItem("userId") || push(ref(db, "users")).key;
    localStorage.setItem("userId", userId);

    function generateRandomName() {
      const adjectives = ["Brave", "Smart", "Quick", "Silent"];
      const nouns = ["Lion", "Falcon", "Tiger", "Eagle"];
      return adjectives[Math.floor(Math.random() * adjectives.length)] + " " + nouns[Math.floor(Math.random() * nouns.length)];
    }

    const userName = localStorage.getItem("userName") || generateRandomName();
    localStorage.setItem("userName", userName);

    const profilePicture = "https://example.com/default-profile.png"; // URL padrão de foto
    const userRef = ref(db, `users/${userId}`);
    onValue(userRef, (snapshot) => {
      if (!snapshot.exists()) {
        const userData = {
          id: userId,
          nome: userName,
          foto_perfil: profilePicture,
          verificado: false,
          ceo: false,
          banido: false,
          mensagens: [],
          cadastro: new Date().toLocaleDateString("pt-BR"),
        };
        set(userRef, userData);
      } else {
        const userData = snapshot.val();
        if (userData.banido) {
          window.location.href = "banido.html";
        }
      }
    });

    // Função para enviar mensagens
    function sendMessage(content) {
      const chatRef = ref(db, "chat");
      const timestamp = new Date().toISOString();
      const message = {
        id_do_usuario: userId,
        nome: userName,
        foto_perfil: profilePicture,
        conteudo: content,
        timestamp: timestamp,
      };
      push(chatRef, message);
    }

    // Função para carregar mensagens
    function loadMessages() {
      const chatRef = ref(db, "chat");
      const messagesContainer = document.getElementById("messages");
      onValue(chatRef, (snapshot) => {
        messagesContainer.innerHTML = ""; // Limpar mensagens antigas
        snapshot.forEach((messageSnapshot) => {
          const message = messageSnapshot.val();
          const messageElement = document.createElement("div");

          if (message.conteudo === "__deleted__") {
            messageElement.textContent = "Essa mensagem foi excluída por um administrador.";
          } else {
            messageElement.innerHTML = `
              <img src="${message.foto_perfil}" alt="${message.nome}" width="30" />
              <strong>${message.nome}</strong>
              ${message.verificado ? '<img src="https://res.cloudinary.com/dfjdlqyjl/image/upload/v1736626740/verificar_1_qtfrdt.png" alt="Verificado" width="20" />' : ""}
              ${message.ceo ? '<img src="https://res.cloudinary.com/dfjdlqyjl/image/upload/v1736626740/verificar_i35hrp.png" alt="CEO" width="20" />' : ""}
              <p>${message.conteudo}</p>
              <small>${new Date(message.timestamp).toLocaleString("pt-BR")}</small>
            `;
          }
          messagesContainer.appendChild(messageElement);
        });
      });
    }

    // Inicializar o chat
    document.addEventListener("DOMContentLoaded", () => {
      loadMessages();
      document.getElementById("send-message").addEventListener("click", () => {
        const messageInput = document.getElementById("message-input");
        const messageContent = messageInput.value.trim();
        if (messageContent) {
          sendMessage(messageContent);
          messageInput.value = "";
        }
      });
    });

    // Função para excluir mensagens
    function deleteMessage(messageId) {
      update(ref(db, `chat/${messageId}`), {
        conteudo: "__deleted__",
      });
    }
  </script>
  <style>
    /* Estilos básicos */
    #chat-container {
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background-color: #f9f9f9;
    }
    #messages {
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 10px;
      height: 300px;
      overflow-y: auto;
      background-color: #fff;
    }
    textarea {
      width: calc(100% - 20px);
      margin: 10px 0;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      resize: none;
    }
    button {
      width: 100%;
      padding: 10px;
      background-color: #4caf50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    img {
      border-radius: 50%;
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <div id="chat-container">
    <div id="messages"></div>
    <textarea id="message-input" placeholder="Digite sua mensagem"></textarea>
    <button id="send-message">Enviar</button>
  </div>
</body>
</html>
