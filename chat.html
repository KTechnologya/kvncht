<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Real-time</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
    <script type="module">
        // Importações Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getDatabase, ref, push, onValue, update, set } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-storage.js";

        // Configuração Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAka2HFWwP9OHc_OC2IDFio0wPPtqADhmA",
            authDomain: "kelvinchat-f9499.firebaseapp.com",
            databaseURL: "https://kelvinchat-f9499-default-rtdb.firebaseio.com",
            projectId: "kelvinchat-f9499",
            storageBucket: "kelvinchat-f9499.appspot.com",
            messagingSenderId: "972962322611",
            appId: "1:972962322611:web:ff5416bb049abea350f8c6",
            measurementId: "G-K99GCK98ZR"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        const storage = getStorage(app);

        let currentUser = null;

        // Inicializar o chat
        function initializeChat() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    const userRef = ref(database, `users/${user.uid}`);
                    onValue(userRef, (snapshot) => {
                        const userData = snapshot.val();
                        if (userData && userData.banned) {
                            window.location.href = "banido.html";
                        } else {
                            currentUser = { uid: user.uid, ...userData };
                            loadChatMessages();
                        }
                    });
                } else {
                    window.location.href = "login.html";
                }
            });
        }

        // Carregar mensagens do chat
        function loadChatMessages() {
            const chatRef = ref(database, 'chat');
            const chatList = document.getElementById('chat-list');

            onValue(chatRef, (snapshot) => {
                chatList.innerHTML = '';
                snapshot.forEach((childSnapshot) => {
                    const message = childSnapshot.val();
                    const messageElement = createMessageElement(message, childSnapshot.key);
                    chatList.appendChild(messageElement);
                });
                chatList.scrollTop = chatList.scrollHeight;
            });
        }

        // Criar elemento de mensagem
        function createMessageElement(message, key) {
            const verifiedIcon = message.verified
                ? `<img src="https://res.cloudinary.com/dfjdlqyjl/image/upload/v1736626740/verificar_1_qtfrdt.png" class="w-4 h-4 ml-2"/>`
                : '';
            const ceoIcon = message.ceo
                ? `<img src="https://res.cloudinary.com/dfjdlqyjl/image/upload/v1736626740/verificar_i35hrp.png" class="w-4 h-4 ml-2"/>`
                : '';
            const content = message.deleted
                ? '<span class="italic text-gray-500">Essa mensagem foi apagada por um administrador</span>'
                : message.content;

            return `
                <div class="p-4 border-b">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center font-bold text-white">
                            ${message.name.charAt(0).toUpperCase()}
                        </div>
                        <div class="ml-3">
                            <h2 class="text-lg font-semibold">
                                ${message.name} ${verifiedIcon} ${ceoIcon}
                            </h2>
                            <p class="text-gray-600">${content}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Enviar mensagem
        function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();

            if (message && currentUser) {
                const chatRef = ref(database, 'chat');
                push(chatRef, {
                    name: currentUser.name,
                    content: message,
                    verified: currentUser.verified || false,
                    ceo: currentUser.ceo || false,
                    timestamp: Date.now()
                });
                messageInput.value = '';
            }
        }

        // Enviar imagem
        async function sendImage(file) {
            if (file && currentUser) {
                const storagePath = `uploads/${Date.now()}-${file.name}`;
                const imageRef = storageRef(storage, storagePath);

                await uploadBytes(imageRef, file);
                const downloadURL = await getDownloadURL(imageRef);

                const chatRef = ref(database, 'chat');
                push(chatRef, {
                    name: currentUser.name,
                    content: `<img src="${downloadURL}" alt="Enviado" class="max-w-full"/>`,
                    verified: currentUser.verified || false,
                    ceo: currentUser.ceo || false,
                    timestamp: Date.now()
                });
            }
        }

        // Arquivo selecionado
        function handleFileInput(event) {
            const file = event.target.files[0];
            sendImage(file);
        }

        window.sendMessage = sendMessage;
        window.handleFileInput = handleFileInput;
        window.initializeChat = initializeChat;

        document.addEventListener("DOMContentLoaded", initializeChat);
    </script>
</head>
<body class="bg-gray-100">
    <div class="flex flex-col h-screen">
        <header class="bg-green-600 text-white p-4 text-center font-bold text-xl">
            Chat Real-time
        </header>
        <div id="chat-list" class="flex-1 overflow-y-auto p-4 bg-white"></div>
        <div class="p-4 flex items-center bg-gray-200 border-t">
            <input id="message-input" type="text" placeholder="Digite uma mensagem..." class="flex-1 p-2 rounded-full border"/>
            <input id="file-input" type="file" class="hidden" onchange="handleFileInput(event)"/>
            <button onclick="document.getElementById('file-input').click()" class="ml-4 text-green-600">
                <i class="fas fa-paperclip"></i>
            </button>
            <button onclick="sendMessage()" class="ml-4 text-green-600">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</body>
</html>
